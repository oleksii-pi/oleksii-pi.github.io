<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Math Problem Generator</title>
    <script src="levels.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100vh;
            background-color: #f0f0f0;
            touch-action: manipulation;
            -webkit-user-select: none; /* Prevents accidental selection and zoom */
            overscroll-behavior: none; /* Prevents pull-to-refresh */
            -webkit-overscroll-behavior: none; /* Safari specific */
        }
        .container {
            max-width: 600px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .level-selector {
            margin-top: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            
        }

        .level-selector label {
            font-size: 1em;
            margin: 0;
        }

        .level-selector input {
            font-size: 1em;
            padding: 5px;
            width: 40px;
            text-align: center;
            border: 2px solid #eee;
            margin: 0;
        }

        .level-selector .gray {
            font-size: 1em;
            margin: 0;
            padding: 5px 10px;
            height: auto;
        }

        #problem {
            font-size: 3em;
            margin-top: 20px;
        }

        /* Removed the original input styling and replaced with a display box */
        .answer-display {
            font-size: 1.5em;
            padding: 10px;
            margin-top: 20px;
            margin-bottom: 10px;
            border: 2px solid #ccc;
            border-radius: 5px;
            width: 80%;
            margin-left: auto;
            margin-right: auto;
            background-color: #fafafa;
        }

        /* Error highlight (if you wish to highlight the display box on error) */
        .error-display {
            border-color: red !important;
        }

        /* Help button styling */
        .help-button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 1em;
            margin-left: 10px;
            cursor: pointer;
            display: none;
        }

        .help-button:hover {
            background-color: #218838;
        }

        .answer-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        button.gray {
            margin-top: 10px;
            font-size: 1em;
            border: none;
            background-color: lightgray;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }
        button {
            margin-top: 10px;
            font-size: 1em;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }

        /* Keypad styling */
        .keypad {
            display: inline-block;
            margin-top: 20px;
        }
        .keypad .row {
            display: flex;
            justify-content: center;
            margin: 5px 0;
        }
        .keypad button {
            width: 60px;
            height: 60px;
            font-size: 2em;
            margin: 0 5px;
            padding: 0;
            border-radius: 8px;
        }
        .keypad button.mainaction,
        .keypad button.dangerous {
            font-size: 1em;
        }
        .answer-display {
                min-height: 1.2em;
        }
        .mainaction {
            background-color: #28a745;
        }
        .dangerous {
            background-color: #dc3545;
        }

        #log {
            display: none;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
            background-color: #e8e8e8;
            padding: 10px;
            border-radius: 5px;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
        }

        /* Success emoji styling */
        #successEmoji {
            font-size: 2em;
            margin-bottom: 10px;
            opacity: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="problem"></div>

        <!-- Success emoji display -->
        <div id="successEmoji">🎉</div>

        <!-- Display for typed answer -->
        <div class="answer-container">
            <div id="answerDisplay" class="answer-display">
            </div>
            <button id="helpButton" class="help-button">💡</button>
        </div>

        <!-- Visual numeric keyboard -->
        <div class="keypad">
            <div class="row">
                <button class="num" data-value="1">1</button>
                <button class="num" data-value="2">2</button>
                <button class="num" data-value="3">3</button>
            </div>
            <div class="row">
                <button class="num" data-value="4">4</button>
                <button class="num" data-value="5">5</button>
                <button class="num" data-value="6">6</button>
            </div>
            <div class="row">
                <button class="num" data-value="7">7</button>
                <button class="num" data-value="8">8</button>
                <button class="num" data-value="9">9</button>
            </div>
            <div class="row">
                <button class="dangerous" id="del" >Delete</button>
                <button class="num" data-value="0">0</button>
                <button class="mainaction" id="enterAnswer">Enter</button>
            </div>
        </div>

        <div class="level-selector">
            <button id="decreaseLevel" class="gray">-</button>
            <input type="number" id="levelInput" min="1" max="5" value="1" readonly>
            <button id="increaseLevel" class="gray">+</button>
            <button id="showLogs" class="gray">Stats</button>
        </div>
        <label id="clipboardLabel" style="display: none; color: #666; font-size: 0.9em; margin-top: 10px;">Results have been copied to the clipboard</label>
        <div id="log"></div>
    </div>

    <script>
        const problemElement = document.getElementById('problem');
        const logElement = document.getElementById('log');
        const showLogsButton = document.getElementById('showLogs');
        const enterAnswerButton = document.getElementById('enterAnswer');
        const answerDisplay = document.getElementById('answerDisplay');
        const successEmoji = document.getElementById('successEmoji');
        const levelInput = document.getElementById('levelInput');
        const helpButton = document.getElementById('helpButton');

        const deleteButton = document.getElementById('del');
        deleteButton.addEventListener('click', () => {
            typedAnswer = typedAnswer.slice(0, -1);
            answerDisplay.classList.remove('error-display');
            updateAnswerDisplay();
        });

        let currentProblem = {};
        let sessionLog = [];
        let startTime = null;
        let typedAnswer = ''; // user-typed answer via keypad
        let incorrectAttempts = 0; // track incorrect attempts for current problem
        let sessionStartTime = new Date(); // track session start time
        let totalProblems = 0; // count total problems attempted
        let successfulProblems = 0; // count successful problems

        // Cookie functions for level persistence
        function setCookie(name, value, days = 365) {
            const expires = new Date();
            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        function generateNewProblem() {
            const level = parseInt(levelInput.value, 10);
            let newProblem;
            
            // Generate a new problem, ensuring it's different from the current one
            do {
                newProblem = generateProblem(level);
            } while (currentProblem && newProblem.question === currentProblem.question);
            
            currentProblem = newProblem;
            problemElement.textContent = currentProblem.question;
            startTime = new Date();
            incorrectAttempts = 0; // Reset incorrect attempts for new problem
        }

        function logEntry(entry) {
            sessionLog.push(entry);
        }

        function updateLog() {
            const sessionDuration = Math.round((new Date() - sessionStartTime) / 1000);
            const minutes = Math.floor(sessionDuration / 60);
            const seconds = sessionDuration % 60;
            const successRate = totalProblems > 0 ? Math.round((successfulProblems / totalProblems) * 100) : 0;
            
            const statsEntry = `📊 Duration: ${minutes}m ${seconds}s | Exercises: ${totalProblems} | Success: ${successRate}% (${successfulProblems}/${totalProblems})`;
            
            // Insert stats as second entry (after session started)
            const logWithStats = [sessionLog[0], statsEntry, ...sessionLog.slice(1)];
            logElement.innerHTML = logWithStats.join('<br>');
        }

        function updateAnswerDisplay() {
            answerDisplay.textContent = typedAnswer;
        }

        function showSuccessEmoji() {
            const emojisByLevel = [
                ['🎉','🥳','👏','👍','😊','🎈','✨','🌈','🍭','🦄'],
                ['⭐','🌟','💫','🎊','🙌','🫶','🤗','🎀','🌞','🌼'],
                ['✅','✔️','☑️','💪','😁','🚀','😎','🌟','🎯','🔥'],
                ['🤩','🙌','🏅','🎯','🧠','🔓','🔑','📈','🛡️','🎖️'],
                ['🌈','✨','🪄','🍀','🧸','🎠','🍎','🧮','📚','🎈'],
                ['🚀','🛰️','🛸','🧪','🧩','🗝️','⚡','🏆','🥇','🎯'],
                ['💡','🧠','🔎','🧩','📘','🔬','🧭','🏅','🎯','✅'],
                ['😎','🔥','🏆','👑','💎','🚀','🎯','📈','⭐','💥'],
                ['🌟','🎖️','🏅','🥇','🏆','🛡️','⚡','🎯','🧠','💪'],
                ['🏆','🥇','👑','💎','🔥','🎯','🚀','🌟','💫','✅'],
                ['🌠','🛸','🚀','🧠','📈','🗝️','🔓','🎯','🏆','💥'],
                ['🤓','🧠','📚','🧮','🎯','🏅','✅','🚀','🌟','💡'],
                ['💎','🔥','👑','🏆','😎','🪙','🎯','🚀','🌟','✅'],
                ['🏆','👑','💎','🌠','⚡','🔥','🎯','🚀','📈','🥇']
            ];
            
            const currentLevel = parseInt(levelInput.value, 10);
            const levelIndex = Math.min(currentLevel - 1, emojisByLevel.length - 1);
            const emojis = emojisByLevel[levelIndex];
            const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
            
            successEmoji.textContent = randomEmoji;
            successEmoji.style.opacity = 1;
            setTimeout(() => {
                successEmoji.style.opacity = 0;
            }, 2000);
        }

        function checkAnswer() {
            // parse typed answer
            const userAnswer = parseInt(typedAnswer, 10);
            const timeTaken = Math.round((new Date() - startTime) / 1000);

            // if typedAnswer is not valid, do nothing
            if (isNaN(userAnswer)) {
                return;
            }

            if (userAnswer === currentProblem.answer) {
                totalProblems++;
                successfulProblems++;
                logEntry(
                    `✅ ${currentProblem.question} = ${userAnswer} ` +
                    `(${timeTaken}s)`
                );
                answerDisplay.classList.remove('error-display');
                helpButton.style.display = 'none';
                problemElement.textContent = currentProblem.question; // Reset title
                typedAnswer = '';
                updateAnswerDisplay();
                showSuccessEmoji();
                generateNewProblem();
            } else {
                incorrectAttempts++;
                totalProblems++;
                logEntry(
                    `❌ ${currentProblem.question} = ${userAnswer} Incorrect ` +
                    `(${timeTaken}s)`
                );
                answerDisplay.classList.add('error-display');
                // Show help button only after second incorrect attempt
                if (incorrectAttempts >= 2) {
                    helpButton.style.display = 'inline-block';
                }
                startTime = new Date();
            }

            updateLog();
        }

        // Handle numeric keypad clicks
        document.querySelectorAll('.num').forEach(btn => {
            btn.addEventListener('click', () => {
                typedAnswer += btn.dataset.value;
                answerDisplay.classList.remove('error-display');
                updateAnswerDisplay();
            });
        });

        // Help button click handler
        helpButton.addEventListener('click', () => {
            const timeTaken = Math.round((new Date() - startTime) / 1000);
            logEntry(`💡 ${currentProblem.question} = ? Help requested (${timeTaken}s)`);
            updateLog();
            problemElement.textContent = `${currentProblem.question} = ${currentProblem.answer}`;
        });

        enterAnswerButton.addEventListener('click', checkAnswer);

        showLogsButton.addEventListener('click', () => {
            const clipboardLabel = document.getElementById('clipboardLabel');
            // Check if log is currently visible (handles both 'none' and '' cases)
            const isVisible = window.getComputedStyle(logElement).display !== 'none';
            logElement.style.display = isVisible ? 'none' : 'block';
            clipboardLabel.style.display = isVisible ? 'none' : 'block';
            
            // Copy stats to clipboard when showing logs
            if (!isVisible) {
                const sessionDuration = Math.round((new Date() - sessionStartTime) / 1000);
                const minutes = Math.floor(sessionDuration / 60);
                const seconds = sessionDuration % 60;
                const successRate = totalProblems > 0 ? Math.round((successfulProblems / totalProblems) * 100) : 0;
                
                const statsHeader = [
                    `📊 Session Statistics:`,
                    `⏱️ Duration: ${minutes}m ${seconds}s`,
                    `📝 Total exercises: ${totalProblems}`,
                    `✅ Success rate: ${successRate}% (${successfulProblems}/${totalProblems})`,
                    `---`
                ];
                const statsText = statsHeader.join('\n') + '\n' + sessionLog.join('\n');
                navigator.clipboard.writeText(statsText).then(() => {
                    console.log('Stats copied to clipboard');
                }).catch(err => {
                    console.error('Failed to copy stats to clipboard:', err);
                });
            }
        });

        // Level increase/decrease buttons
        document.getElementById('increaseLevel').addEventListener('click', () => {
            const currentLevel = parseInt(levelInput.value, 10);
            if (currentLevel < getLevelCount()) {
                levelInput.value = currentLevel + 1;
                setCookie('mathProblemLevel', levelInput.value);
                generateNewProblem();
            }
        });

        document.getElementById('decreaseLevel').addEventListener('click', () => {
            const currentLevel = parseInt(levelInput.value, 10);
            if (currentLevel > 1) {
                levelInput.value = currentLevel - 1;
                setCookie('mathProblemLevel', levelInput.value);
                generateNewProblem();
            }
        });

        // Set the max level based on getLevelCount()
        levelInput.max = getLevelCount();
        
        // Load saved level from cookie
        const savedLevel = getCookie('mathProblemLevel');
        if (savedLevel && savedLevel >= 1 && savedLevel <= getLevelCount()) {
            levelInput.value = savedLevel;
        }
        
        logEntry(`📚 Session started (${new Date().toLocaleString()})`);
        generateNewProblem();
        updateAnswerDisplay();
        
        // Prevent pull-to-refresh and show confirmation before leaving
        window.addEventListener('beforeunload', function (e) {
            const confirmationMessage = 'Are you sure you want to leave? Your progress will be lost.';
            e.preventDefault();
            e.returnValue = confirmationMessage;
            return confirmationMessage;
        });

        // Additional prevention for mobile Safari pull-to-refresh
        let startY = null;

        document.addEventListener('touchstart', function(e) {
            startY = e.touches[0].clientY;
        }, { passive: true });

        document.addEventListener('touchmove', function(e) {
            const currentY = e.touches[0].clientY;
            const deltaY = currentY - startY;
            
            // Only prevent if at top of page and pulling down
            if (window.scrollY === 0 && deltaY > 0) {
                e.preventDefault();
            }
        }, { passive: false });

        // Handle keyboard events
        document.addEventListener('keydown', function(e) {
            if (e.code === 'Space') {
                e.preventDefault();
                generateNewProblem();
            }
        });
    </script>
</body>
</html>
